---
title: Bewährte Methoden für Azure Cosmos DB für .NET SDK v3
description: Hier finden Sie die bewährten Methoden für die Verwendung des Azure Cosmos DB .NET SDK v3
author: StefArroyo
ms.service: cosmos-db
ms.subservice: cosmosdb-sql
ms.topic: how-to
ms.date: 08/26/2021
ms.author: esarroyo
ms.openlocfilehash: b07162b95419a73be4bdecc5ff3160ded1c2a0e5
ms.sourcegitcommit: 40866facf800a09574f97cc486b5f64fced67eb2
ms.translationtype: HT
ms.contentlocale: de-DE
ms.lasthandoff: 08/30/2021
ms.locfileid: "123219619"
---
# <a name="best-practices-for-azure-cosmos-db-net-sdk"></a>Bewährte Methoden für Azure Cosmos DB .NET SDK
[!INCLUDE[appliesto-sql-api](../includes/appliesto-sql-api.md)]

In diesem Artikel werden die bewährten Methoden für die Verwendung des Azure Cosmos DB .NET SDK beschrieben. Wenn Sie diese Vorgehensweisen befolgen, lassen sich Wartezeiten reduzieren, die Verfügbarkeit verbessern und die Gesamtleistung steigern. 

Sehen Sie sich das folgende Video an, um mehr über die Verwendung des .NET SDK von einem Cosmos DB-Experten zu erfahren!


> [!VIDEO https://www.youtube.com/embed/McZIQhZpvew?start=118]
>

## <a name="checklist"></a>Checkliste
|Überprüft  | Thema  |Details/Links  |
|---------|---------|---------|
|<input type="checkbox"/> |    SDK-Version    |   Verwenden Sie für eine optimale Leistung immer die [aktuelle Version](sql-api-sdk-dotnet-standard.md) des Cosmos DB SDK.     |
| <input type="checkbox"/>   |    Singleton-Client     |       Verwenden Sie für eine [bessere Leistung](performance-tips-dotnet-sdk-v3-sql.md#sdk-usage) eine [Einzelinstanz](/dotnet/api/microsoft.azure.cosmos.cosmosclient?view=azure-dotnet&preserve-view=true) von `CosmosClient` für die Lebensdauer Ihrer Anwendung.     |
| <input type="checkbox"/>  |     Regions     |   Führen Sie Ihre Anwendung nach Möglichkeit in der gleichen [Azure-Region](../distribute-data-globally.md) aus wie Ihr Azure Cosmos DB-Konto. Durch diese Vorgehensweise lassen sich Wartezeiten reduzieren. Aktivieren Sie 2–4 Regionen, und replizieren Sie Ihre Konten in mehreren Regionen, um die [beste Verfügbarkeit](../distribute-data-globally.md) zu erzielen. Aktivieren Sie für Produktionsworkloads ein [automatisches Failover](../how-to-manage-database-account.md#configure-multiple-write-regions). Ohne diese Konfiguration verliert das Konto für die gesamte Dauer des Ausfalls der Schreibregion die Schreibverfügbarkeit, da das manuelle Failover aufgrund der fehlenden Regionskonnektivität nicht erfolgreich verläuft. Informationen zum Hinzufügen mehrerer Regionen mit dem .NET SDK finden Sie [hier](tutorial-global-distribution-sql-api.md)   |
| <input type="checkbox"/>   |   Verfügbarkeit und Failover     |  Legen Sie [ApplicationPreferredRegions](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationpreferredregions?view=azure-dotnet&preserve-view=true) oder [ApplicationRegion](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationregion?view=azure-dotnet&preserve-view=true) im v3-SDK und [PreferredLocations](/dotnet/api/microsoft.azure.documents.client.connectionpolicy.preferredlocations?view=azure-dotnet&preserve-view=true) im v2-SDK über die [Liste der bevorzugten Regionen](./tutorial-global-distribution-sql-api.md?tabs=dotnetv3%2capi-async#preferred-locations) fest. Während eines Failovers werden Schreibvorgänge an die aktuelle Schreibregion gesendet, und alle Lesevorgänge werden an die erste Region in der Liste der bevorzugten Regionen gesendet. Weitere Informationen zu regionalen Failovermechanismen finden Sie im [Leitfaden zur Problembehandlung bei der Verfügbarkeit](troubleshoot-sdk-availability.md). |
|  <input type="checkbox"/> |    CPU     |  Aufgrund fehlender Ressourcen auf Ihrem Clientcomputer kann es zu Verbindungs-/Verfügbarkeitsproblemen kommen. Überwachen Sie die CPU-Auslastung auf Knoten, auf denen der Azure Cosmos DB-Client ausgeführt wird, und führen Sie bei einer sehr hohen Auslastung eine Hoch- bzw. Aufskalierung durch.      |
| <input type="checkbox"/>   |    Hosting      |   Verwenden Sie für eine maximale Leistung nach Möglichkeit die [Windows-64-Bit-Hostverarbeitung](performance-tips.md#hosting).       |
| <input type="checkbox"/> |    Konnektivitätsmodi    |    Verwenden Sie für eine optimale Leistung den [direkten Modus](sql-sdk-connection-modes.md).  Entsprechende Anweisungen finden Sie in der [Dokumentation zum v3-SDK](performance-tips-dotnet-sdk-v3-sql.md#networking) oder in der [Dokumentation zum v2-SDK](performance-tips.md#networking).|
|<input type="checkbox"/>  |    Netzwerk   | Wenn Sie einen virtuellen Computer zum Ausführen Ihrer Anwendung verwenden, aktivieren Sie den [beschleunigten Netzwerkbetrieb](../../virtual-network/create-vm-accelerated-networking-powershell.md) auf Ihrem virtuellen Computer, um Engpässen aufgrund von hohem Datenverkehrsaufkommen entgegenzuwirken und Wartezeiten oder CPU-Jitter zu reduzieren. Darüber hinaus sollten Sie die Verwendung eines leistungsstärkeren virtuellen Computers in Betracht ziehen, bei dem die maximale CPU-Auslastung unter 70 % liegt.    |
|<input type="checkbox"/> |  Kurzfristige Portauslastung      | Für eine geringe Anzahl von Verbindungen oder sporadische Verbindungen legen wir [`IdleConnectionTimeout`](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.idletcpconnectiontimeout?view=azure-dotnet&preserve-view=true) und [`PortReuseMode`](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.portreusemode?view=azure-dotnet&preserve-view=true) auf `PrivatePortPool` fest. Mithilfe der `IdleConnectionTimeout`-Eigenschaft lässt sich die Zeit steuern, in der nicht verwendete Verbindungen geschlossen werden. Dadurch lässt sich die Anzahl von nicht verwendeten Verbindungen reduzieren. Standardmäßig werden Verbindungen im Leerlauf unbegrenzt geöffnet gehalten. Dieser Wert muss auf 10 Minuten oder mehr festgelegt werden. Empfohlen werden Werte zwischen 20 Minuten und 24 Stunden.  Über die Eigenschaft `PortReuseMode` kann das SDK einen kleinen Pool von kurzlebigen Ports für verschiedene Azure Cosmos DB-Zielendpunkte verwenden.    |
|<input type="checkbox"/> |  Verwenden von async/await-Mustern     |  Vermeiden Sie blockierende Aufrufe: `Task.Result`, `Task.Wait` und `Task.GetAwaiter().GetResult()`. Die gesamte Aufrufliste ist asynchron, um von [async/await](/dotnet/csharp/programming-guide/concepts/async/)-Mustern zu profitieren. Viele synchrone blockierende Aufrufe führen zu einer [Blockierung des Threadpools](/archive/blogs/vancem/diagnosing-net-core-threadpool-starvation-with-perfview-why-my-service-is-not-saturating-all-cores-or-seems-to-stall) und längeren Antwortzeiten. |
|<input type="checkbox"/>  |   End-to-End-Timeouts | Für End-to-End-Timeouts müssen sowohl `RequestTimeout`- als auch `CancellationToken`-Parameter verwendet werden. Weitere Einzelheiten zu Timeouts bei Cosmos DB finden Sie [hier](troubleshoot-dot-net-sdk-request-timeout.md) |
|<input type="checkbox"/>  |   Wiederholungslogik      |   Ein vorübergehender Fehler ist ein Fehler, dessen Ursache sich innerhalb kurzer Zeit von selbst auflöst. Anwendungen, die eine Verbindung mit der Datenbank herstellen, sollten dafür ausgelegt sein, vorübergehende Fehler zu tolerieren. Behandeln Sie diese Fehler, indem Sie Wiederholungslogik in Ihrem Code implementieren und vermeiden, dass die Fehler Benutzern als Anwendungsfehler gemeldet werden. Das SDK verfügt über integrierte Logik, um diese vorübergehenden Fehler bei wiederholbaren Anforderungen wie Lese- oder Abfragevorgängen zu behandeln. Da Schreibvorgänge nicht idempotent sind, versucht das SDK bei vorübergehenden Fehlern nicht, diese Vorgänge zu wiederholen. Benutzer können jedoch Wiederholungslogik für Drosselungen konfigurieren. Einzelheiten zu den Fehlern, bei denen ein Vorgang wiederholt wird, finden Sie [hier](troubleshoot-dot-net-sdk.md#retry-logics) |
|<input type="checkbox"/>  |     Zwischenspeichern von Datenbank-/Sammlungsnamen    |    Rufen Sie die Namen Ihrer Datenbanken und Container aus der Konfiguration ab, oder speichern Sie sie beim Starten zwischen. Aufrufe wie `ReadDatabaseAsync` oder `ReadDocumentCollectionAsync` sowie `CreateDatabaseQuery` oder `CreateDocumentCollectionQuery` führen zu Metadatenaufrufen an den Dienst. Dabei wird die für das System reservierte RU-Kapazität genutzt. `CreateIfNotExist` sollte ebenfalls nur einmal zum Einrichten der Datenbank verwendet werden. Diese Vorgänge sollten insgesamt selten ausgeführt werden.       |
|<input type="checkbox"/> |     Unterstützung für Massenvorgänge      |     In Szenarios, in denen keine Optimierung der Wartezeiten erforderlich ist, empfiehlt es sich, die [Unterstützung für Massenvorgänge](https://devblogs.microsoft.com/cosmosdb/introducing-bulk-support-in-the-net-sdk/) zum Sichern großer Datenmengen zu aktivieren.    |
| <input type="checkbox"/>  |     Parallele Abfragen     |    Für geringere Wartezeiten und einen höheren Durchsatz bei Ihren Abfragen unterstützt das Cosmos DB SDK das [parallele Ausführen von Abfragen](performance-tips-dotnet-sdk-v3-sql.md#sdk-usage).  Es wird empfohlen, die `MaxConcurrency`-Eigenschaft innerhalb von `QueryRequestsOptions` auf die Anzahl Ihrer Partitionen festzulegen. Wenn Sie die Anzahl von Partitionen nicht kennen, beginnen Sie mit `int.MaxValue`, um eine möglichst geringe Wartezeit zu erhalten. Verringern Sie dann die Anzahl, bis sie den Ressourceneinschränkungen der Umgebung entspricht, um Probleme aufgrund einer hohen CPU-Auslastung zu vermeiden. Legen Sie außerdem `MaxBufferedItemCount` auf die erwartete Anzahl von zurückgegebenen Ergebnissen fest, um die Anzahl von vorab abgerufenen Ergebnissen zu begrenzen. |
| <input type="checkbox"/> |     Backoffs bei Leistungstests      |    Wenn Sie Leistungstests für Ihre Anwendung durchführen, sollten Sie Backoffs mit [`RetryAfter`](performance-tips-dotnet-sdk-v3-sql.md#sdk-usage)-Intervallen implementieren. Durch das Aussetzen wird die geringstmögliche Wartezeit zwischen den Wiederholungsversuchen gewährleistet.   |
|  <input type="checkbox"/>   |   Indizierung     |   Die Indizierungsrichtlinie von Azure Cosmos DB ermöglicht auch die Verwendung von Indizierungspfaden („IndexingPolicy.IncludedPaths“ und „IndexingPolicy.ExcludedPaths“), um anzugeben, welche Dokumentpfade in die Indizierung ein- bzw. ausgeschlossen werden sollen.  Stellen Sie für schnellere Schreibvorgänge sicher, dass nicht verwendete Pfade von der Indizierung ausgeschlossen sind.  Ein Beispiel für das Erstellen von Indizes mit dem SDK finden Sie [hier](performance-tips-dotnet-sdk-v3-sql.md#indexing-policy)   |
|  <input type="checkbox"/>   |    Dokumentgröße  |    Der Anforderungsaufwand eines bestimmten Vorgangs hängt direkt mit der Größe des Dokuments zusammen. Es wird empfohlen, die Größe Ihrer Dokumente zu reduzieren, da Vorgänge für große Dokumente mehr kosten als Vorgänge für kleinere Dokumente.      |
| <input type="checkbox"/>   |     Erhöhen der Anzahl von Threads/Aufgaben    |    Da Azure Cosmos DB-Aufrufe über das Netzwerk erfolgen, müssen Sie eventuell den Parallelitätsgrad Ihrer Anforderungen variieren, um die Wartezeit für die Clientanwendung zwischen Anforderungen auf ein Minimum zu reduzieren. Erstellen Sie bei Verwendung der [.NET Task Parallel Library](/dotnet/standard/parallel-programming/task-parallel-library-tpl) beispielsweise mehrere Hundert Aufgaben für Lese- und Schreibvorgänge in Azure Cosmos DB.     |
|  <input type="checkbox"/> |    Aktivieren von Abfragemetriken     |  Für eine zusätzliche Protokollierung Ihrer Back-End-Abfrageausführungen können Sie SQL-Abfragemetriken mit unserem .NET SDK aktivieren. Eine Anleitung zum Erfassen von SQL-Abfragemetriken finden Sie [hier](profile-sql-api-query.md)    |
|  <input type="checkbox"/>    | SDK-Protokollierung   | Verwenden Sie die SDK-Protokollierung, um zusätzliche Diagnoseinformationen zu erfassen und Probleme im Zusammenhang mit der Wartezeit zu beheben.  Protokollieren Sie die [Diagnosezeichenfolge](/dotnet/api/microsoft.azure.documents.client.resourceresponsebase.requestdiagnosticsstring?view=azure-dotnet&preserve-view=true) im v2-SDK oder [`Diagnostics`](/dotnet/api/microsoft.azure.cosmos.responsemessage.diagnostics?view=azure-dotnet&preserve-view=true) im v3-SDK, um detailliertere Cosmos-Diagnoseinformationen für die aktuelle Anforderung an den Dienst zu erhalten. Erfassen Sie beispielsweise Diagnoseinformationen für jede Ausnahme und für abgeschlossene Vorgänge, wenn `Diagnostics.ElapsedTime` einen festgelegten Schwellenwert überschreitet (wenn Sie z. B. über eine SLA von 10 Sekunden verfügen, erfassen Sie Diagnoseinformationen, sobald `ElapsedTime` > 10 Sekunden ist). Es wird empfohlen, diese Diagnosen nur während Leistungstests zu verwenden.     |

## <a name="best-practices-when-using-gateway-mode"></a>Bewährte Methoden bei Verwendung des Gatewaymodus
Erhöhen Sie `System.Net MaxConnections` pro Host, wenn Sie den Gatewaymodus verwenden. Azure Cosmos DB-Anforderungen erfolgen im Gatewaymodus über HTTPS/REST. Sie unterliegen dem Standardverbindungslimit pro Hostname oder IP-Adresse. Unter Umständen müssen Sie einen höheren Wert für `MaxConnections` festlegen (100 bis 1.000), damit die Clientbibliothek mehrere Verbindungen mit Azure Cosmos DB gleichzeitig nutzen kann. In .NET SDK 1.8.0 und höher ist der Standardwert für `ServicePointManager.DefaultConnectionLimit` 50. Zum Ändern des Werts können Sie `Documents.Client.ConnectionPolicy.MaxConnectionLimit` auf einen höheren Wert festlegen.

## <a name="best-practices-for-write-heavy-workloads"></a>Bewährte Methoden für schreibintensive Workloads
Legen Sie für Workloads mit hohen Erstellungsnutzlasten die Anforderungsoption `EnableContentResponseOnWrite` auf `false` fest. Der Dienst gibt die erstellte oder aktualisierte Ressource nicht mehr an das SDK zurück. Normalerweise verfügt die Anwendung über das zu erstellende Objekt, sodass sie den Dienst nicht benötigt, um es zurückzugeben. Die Headerwerte sind nach wie vor zugänglich wie etwa eine Anforderungsgebühr. Die Deaktivierung der Inhaltsantwort kann die Leistung verbessern, da das SDK keinen Speicher mehr zuweisen oder den Hauptteil der Antwort nicht mehr serialisieren muss. Dies reduziert auch die Auslastung der Netzwerkbandbreite, um die Leistung weiter zu steigern.

## <a name="next-steps"></a>Nächste Schritte
Eine Beispielanwendung zur Evaluierung von Azure Cosmos DB für Hochleistungsszenarien auf einigen Clientcomputern finden Sie unter [Leistungs- und Skalierungstests mit Azure Cosmos DB](performance-testing.md).

Weitere Informationen zum Entwerfen einer auf Skalierung und hohe Leistung ausgelegten Anwendung finden Sie unter [Partitionieren und Skalieren in Azure Cosmos DB](../partitioning-overview.md).

Versuchen Sie, die Kapazitätsplanung für eine Migration zu Azure Cosmos DB durchzuführen? Sie können Informationen zu Ihrem vorhandenen Datenbankcluster für die Kapazitätsplanung verwenden.
* Wenn Sie nur die Anzahl der virtuellen Kerne und Server in Ihrem vorhandenen Datenbankcluster kennen, lesen Sie die Informationen zum [Schätzen von Anforderungseinheiten mithilfe von virtuellen Kernen oder virtuellen CPUs](../convert-vcore-to-request-unit.md) 
* Wenn Sie die typischen Anforderungsraten für Ihre aktuelle Datenbank-Workload kennen, lesen Sie die Informationen zum [Schätzen von Anforderungseinheiten mit dem Azure Cosmos DB-Kapazitätsplaner](estimate-ru-with-capacity-planner.md)
